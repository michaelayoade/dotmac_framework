name: Security Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        npm ci --prefix frontend || echo "âš ï¸ Frontend npm install failed"
        pip install --user safety bandit semgrep || pip install safety bandit semgrep
    
    - name: Frontend Security Audit
      run: |
        cd frontend
        npm audit --audit-level=high
        echo "âœ… Frontend audit completed"
    
    - name: Backend Security Scan
      run: |
        # Python security scanning
        safety scan --output json > safety-report.json || true
        bandit -r . -f json -o bandit-report.json || true
        
        # Semgrep security rules
        semgrep --config=auto --json --output=semgrep-report.json . || true
        
        echo "âœ… Backend security scan completed"
    
    - name: Container Security Scan
      run: |
        # Install Trivy
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        # Scan filesystem for vulnerabilities
        trivy fs . --format json --output trivy-report.json
        
        echo "âœ… Container security scan completed"
    
    - name: Secret Scanning
      run: |
        # Check for hard-coded secrets
        echo "Scanning for hard-coded secrets..."
        
        # Check for common secret patterns
        if grep -r "secret123\|password123\|test123" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=coverage; then
          echo "âŒ Hard-coded secrets found!"
          exit 1
        fi
        
        # Check for API keys in wrong places
        if grep -r "sk_\|pk_\|rk_" . --include="*.js" --include="*.ts" --include="*.py" --exclude-dir=node_modules --exclude-dir=.git; then
          echo "âŒ Potential API keys in source code!"
          exit 1
        fi
        
        echo "âœ… No hard-coded secrets detected"
    
    - name: Security Bootstrap Validation
      env:
        AUTH_ADMIN_EMAIL: "${{ secrets.AUTH_ADMIN_EMAIL }}"
        AUTH_INITIAL_ADMIN_PASSWORD: "${{ secrets.AUTH_INITIAL_ADMIN_PASSWORD }}"
      run: |
        if [ -z "${AUTH_ADMIN_EMAIL:-}" ] || [ -z "${AUTH_INITIAL_ADMIN_PASSWORD:-}" ]; then
          echo "âš ï¸ Skipping bootstrap validation: secrets not configured"
          exit 0
        fi
        # Basic validation of environment variables for security bootstrap
        echo "ðŸ” Validating security bootstrap environment..."
        
        # Check email format
        if [[ ! "${AUTH_ADMIN_EMAIL}" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
          echo "âŒ Invalid email format for AUTH_ADMIN_EMAIL"
          exit 1
        fi
        
        # Check password strength (basic)
        if [[ ${#AUTH_INITIAL_ADMIN_PASSWORD} -lt 12 ]]; then
          echo "âŒ AUTH_INITIAL_ADMIN_PASSWORD too short (minimum 12 characters)"
          exit 1
        fi
        echo "âœ… Security bootstrap environment validated"
    
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json
          semgrep-report.json
          trivy-report.json
        retention-days: 30
    
    - name: Security Gate Summary
      run: |
        echo "## ðŸ”’ Security Gate Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Frontend audit: No high severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Backend security scan: Completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Container scan: Completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Secret scanning: No hard-coded secrets" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Security bootstrap: Environment validated or skipped (no secrets)" >> $GITHUB_STEP_SUMMARY
        
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@v6
      with:
        project: 'DotMac Platform'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --nodePackageSkipDevDependencies
    
    - name: Upload Dependency Check Results
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: reports/
        retention-days: 30
