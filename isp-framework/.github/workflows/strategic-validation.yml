# Strategic Validation Pipeline
# Prevents deployment issues by catching them early in CI/CD

name: Strategic Quality Gates

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHONPATH: src
  DATABASE_URL: postgresql://test:test@localhost:5432/test_db
  REDIS_URL: redis://localhost:6379/0
  ENVIRONMENT: testing

jobs:
  # ===== STRATEGIC VALIDATION GATES =====
  
  strategic-validation:
    name: ğŸ” Strategic Code Validation
    runs-on: ubuntu-latest
    
    services:
      # Test services for validation
      postgres:
        image: postgres:15.8-alpine
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7.4-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: ğŸ”§ Install dependencies
      run: |
        cd isp-framework
        poetry install --no-interaction --no-ansi

    # STRATEGIC GATE 1: Import Resolution Validation
    - name: ğŸ” Validate Python Imports
      run: |
        cd isp-framework
        echo "ğŸ” Validating all Python imports can be resolved..."
        
        python3 -c "
        import ast
        import sys
        import importlib.util
        import os
        from pathlib import Path
        
        failed_files = []
        
        def check_imports(filepath):
            try:
                with open(filepath, 'r') as f:
                    tree = ast.parse(f.read(), filename=str(filepath))
                
                for node in ast.walk(tree):
                    if isinstance(node, (ast.Import, ast.ImportFrom)):
                        if isinstance(node, ast.Import):
                            for alias in node.names:
                                module_name = alias.name
                        elif isinstance(node, ast.ImportFrom):
                            module_name = node.module
                            if module_name is None:
                                continue
                        
                        # Skip relative imports and internal dotmac modules
                        if module_name and (module_name.startswith('dotmac_') or module_name.startswith('.')):
                            continue
                            
                        # Try to find external module
                        try:
                            importlib.util.find_spec(module_name.split('.')[0])
                        except (ImportError, AttributeError, ValueError):
                            print(f'âŒ Import error in {filepath}: Cannot resolve {module_name}')
                            return False
                return True
            except Exception as e:
                print(f'âŒ Syntax error in {filepath}: {e}')
                return False
        
        # Check all Python files
        for py_file in Path('src').rglob('*.py'):
            if not check_imports(py_file):
                failed_files.append(str(py_file))
        
        if failed_files:
            print(f'\\nâŒ Import validation failed for {len(failed_files)} files')
            print('ğŸ’¡ Run: make install-dev to fix missing dependencies')
            sys.exit(1)
        else:
            print('âœ… All imports validated successfully')
        "

    # STRATEGIC GATE 2: Container Version Validation  
    - name: ğŸ³ Validate Container Versions
      run: |
        cd isp-framework
        echo "ğŸ³ Validating container versions are pinned..."
        
        python3 -c "
        import yaml
        import sys
        
        with open('docker-compose.yml', 'r') as f:
            compose = yaml.safe_load(f)
        
        failed_services = []
        
        for service_name, service_config in compose.get('services', {}).items():
            image = service_config.get('image', '')
            if image and 'build' not in service_config:
                if image.endswith(':latest') or image.count(':') == 0:
                    print(f'âŒ Unpinned version: {service_name} uses {image}')
                    failed_services.append(service_name)
                else:
                    print(f'âœ… {service_name}: {image}')
        
        if failed_services:
            print(f'\\nâŒ Found {len(failed_services)} services with unpinned versions')
            print('ğŸ’¡ Pin versions to prevent compatibility issues')
            sys.exit(1)
        else:
            print('\\nâœ… All container versions are properly pinned')
        "

    # STRATEGIC GATE 3: Dependency Health Validation
    - name: ğŸ¥ Validate Service Dependencies
      run: |
        cd isp-framework
        echo "ğŸ¥ Testing service dependency health checks..."
        
        # Test that our health monitoring can connect to services
        poetry run python3 -c "
        import asyncio
        import sys
        import os
        
        # Set up test environment
        os.environ['DATABASE_URL'] = 'postgresql://test:test@localhost:5432/test_db'
        os.environ['REDIS_URL'] = 'redis://localhost:6379/0'
        os.environ['ENVIRONMENT'] = 'testing'
        
        async def test_health_system():
            try:
                from dotmac_isp.core.dependency_health import get_dependency_health_monitor
                
                health_monitor = get_dependency_health_monitor()
                
                # Test database health check
                db_health = await health_monitor.check_database_health()
                print(f'ğŸ“Š Database Health: {db_health.status.value} ({db_health.response_time_ms:.1f}ms)')
                
                # Test Redis health check  
                redis_health = await health_monitor.check_redis_health()
                print(f'ğŸ“Š Redis Health: {redis_health.status.value} ({redis_health.response_time_ms:.1f}ms)')
                
                # Validate health monitoring works
                if db_health.status.value in ['healthy', 'degraded'] and redis_health.status.value in ['healthy', 'degraded']:
                    print('âœ… Health monitoring system validated successfully')
                    return True
                else:
                    print('âŒ Health monitoring system failed validation')
                    return False
                    
            except Exception as e:
                print(f'âŒ Health monitoring validation failed: {e}')
                return False
        
        result = asyncio.run(test_health_system())
        if not result:
            sys.exit(1)
        "

    # STRATEGIC GATE 4: Security Validation
    - name: ğŸ”’ Security Validation
      run: |
        cd isp-framework
        echo "ğŸ”’ Running security validation..."
        
        # Check for common security issues
        poetry run bandit -r src/ -f json -o bandit-report.json || true
        
        # Validate secret management patterns
        poetry run python3 -c "
        import os
        import sys
        from pathlib import Path
        
        print('ğŸ” Checking for hardcoded secrets...')
        
        # Common secret patterns to avoid
        danger_patterns = [
            'password=',
            'secret=', 
            'token=',
            'key=',
            'localhost:6379',  # Our specific Redis issue
            'localhost:5432',  # Our specific PostgreSQL issue
        ]
        
        found_issues = []
        
        for py_file in Path('src').rglob('*.py'):
            with open(py_file, 'r') as f:
                content = f.read().lower()
                for pattern in danger_patterns:
                    if pattern in content and 'test' not in str(py_file).lower():
                        found_issues.append(f'{py_file}: Found \"{pattern}\"')
        
        if found_issues:
            print('âš ï¸ Potential hardcoded credentials found:')
            for issue in found_issues[:5]:  # Show first 5
                print(f'  {issue}')
            print('ğŸ’¡ Use SecretManager or environment variables instead')
        else:
            print('âœ… No hardcoded credentials detected')
        "

    # STRATEGIC GATE 5: Configuration Validation
    - name: âš™ï¸ Configuration Validation
      run: |
        cd isp-framework
        echo "âš™ï¸ Validating configuration management..."
        
        poetry run python3 -c "
        import sys
        import os
        
        # Test settings can be loaded without errors
        try:
            os.environ['ENVIRONMENT'] = 'testing'
            from dotmac_isp.core.settings import get_settings
            from dotmac_isp.core.secret_manager import get_secret_manager
            
            settings = get_settings()
            secret_manager = get_secret_manager()
            
            print(f'âœ… Settings loaded: Environment = {settings.environment}')
            print(f'âœ… Secret manager loaded: Environment = {secret_manager.environment}')
            print('âœ… Configuration system validated')
            
        except Exception as e:
            print(f'âŒ Configuration validation failed: {e}')
            sys.exit(1)
        "

  # ===== OPTIONAL QUALITY GATES (NON-BLOCKING) =====
  
  optional-quality-checks:
    name: ğŸ“Š Optional Quality Checks
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking
    
    steps:
    - name: ğŸ“¥ Checkout code  
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: ğŸ”§ Install dependencies
      run: |
        cd isp-framework
        poetry install --no-interaction --no-ansi

    # Optional: Code formatting (non-blocking)
    - name: ğŸ¨ Check Code Formatting
      continue-on-error: true
      run: |
        cd isp-framework
        echo "ğŸ¨ Checking code formatting (optional)..."
        poetry run black --check --diff src/ || echo "âš ï¸ Code formatting issues found (non-blocking)"

    # Optional: Linting (non-blocking) 
    - name: ğŸ” Linting
      continue-on-error: true
      run: |
        cd isp-framework
        echo "ğŸ” Running linting checks (optional)..."
        poetry run ruff check src/ || echo "âš ï¸ Linting issues found (non-blocking)"

    # Optional: Type checking (non-blocking)
    - name: ğŸ·ï¸ Type Checking  
      continue-on-error: true
      run: |
        cd isp-framework
        echo "ğŸ·ï¸ Running type checks (optional)..."
        poetry run mypy src/ --ignore-missing-imports || echo "âš ï¸ Type checking issues found (non-blocking)"

  # ===== RESULTS SUMMARY =====
  
  validation-summary:
    name: ğŸ“‹ Validation Summary
    runs-on: ubuntu-latest
    needs: [strategic-validation, optional-quality-checks]
    if: always()
    
    steps:
    - name: ğŸ“‹ Summary
      run: |
        echo "## ğŸ¯ Strategic Validation Results"
        echo ""
        echo "âœ… **Strategic Gates (Required):**"
        echo "- Import Resolution: ${{ needs.strategic-validation.result }}"
        echo "- Container Versions: ${{ needs.strategic-validation.result }}"  
        echo "- Dependency Health: ${{ needs.strategic-validation.result }}"
        echo "- Security Validation: ${{ needs.strategic-validation.result }}"
        echo "- Configuration: ${{ needs.strategic-validation.result }}"
        echo ""
        echo "ğŸ“Š **Optional Quality Checks:**"
        echo "- Code Quality: ${{ needs.optional-quality-checks.result }} (non-blocking)"
        echo ""
        if [[ "${{ needs.strategic-validation.result }}" == "success" ]]; then
          echo "ğŸ‰ **All strategic validation gates passed!**"
          echo "Code is ready for deployment."
        else
          echo "âŒ **Strategic validation failed**"
          echo "Review and fix issues before deployment."
        fi