version: '3.8'

services:
  # MinIO S3-compatible storage for testing
  test-minio:
    image: minio/minio:RELEASE.2024-08-29T01-40-52Z
    container_name: dotmac-test-minio
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Web Console
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password123
      MINIO_DOMAIN: minio.test.dotmac.local
    volumes:
      - minio-data:/data
      - ./minio-config:/etc/minio
    networks:
      - dotmac-test
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ClamAV antivirus scanner
  test-clamav:
    image: clamav/clamav:1.2.1
    container_name: dotmac-test-clamav
    ports:
      - "3310:3310"  # ClamAV daemon
    environment:
      CLAMAV_NO_FRESHCLAMD: "true"  # Skip virus DB updates for testing
    volumes:
      - clamav-db:/var/lib/clamav
      - ./clamav-config:/etc/clamav
    networks:
      - dotmac-test
    healthcheck:
      test: ["CMD", "clamdscan", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # File Storage Test Service
  file-storage-tester:
    build:
      context: ./file-storage-tester
      dockerfile: Dockerfile
    container_name: dotmac-file-storage-tester
    ports:
      - "8081:8080"  # Test API and results
    depends_on:
      test-minio:
        condition: service_healthy
      test-clamav:
        condition: service_healthy
    environment:
      # S3 Configuration
      S3_ENDPOINT: http://test-minio:9000
      S3_ACCESS_KEY: admin
      S3_SECRET_KEY: password123
      S3_REGION: us-east-1
      S3_USE_SSL: "false"
      
      # ClamAV Configuration  
      CLAMAV_HOST: test-clamav
      CLAMAV_PORT: 3310
      
      # Test Configuration
      TEST_BUCKET_PREFIX: dotmac-tenant
      MAX_FILE_SIZE: 104857600  # 100MB
      CHUNK_SIZE: 8388608       # 8MB chunks
      ANTIVIRUS_ENABLED: "true"
      
      # Tenant Configuration
      TEST_TENANTS: "tenant-001,tenant-002,tenant-003"
    volumes:
      - ./test-files:/app/test-files:ro
      - file-test-results:/app/results
    networks:
      - dotmac-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

# File Upload Simulator removed for now - core tests run directly in file-storage-tester

networks:
  dotmac-test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  minio-data:
  clamav-db:
  file-test-results: