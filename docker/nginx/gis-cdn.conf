# ============================================================================
# GIS CDN Nginx Configuration
# Optimized for serving map tiles and static GIS assets
# ============================================================================

# Upstream servers for load balancing (if needed)
upstream gis_backend {
    least_conn;
    server dotmac-isp:8000;
    server dotmac-management:8001 backup;
}

# Enable gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types
    application/javascript
    application/json
    application/x-javascript
    text/css
    text/javascript
    text/xml
    text/plain
    application/xml
    application/xml+rss
    image/svg+xml;

# Enable brotli compression if available
load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

brotli on;
brotli_comp_level 6;
brotli_types
    application/javascript
    application/json
    text/css
    text/javascript
    text/xml
    text/plain
    application/xml
    image/svg+xml;

# Rate limiting
limit_req_zone $binary_remote_addr zone=gis_api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=gis_assets:10m rate=100r/s;

server {
    listen 80;
    server_name cdn.local.dotmac.com gis-assets.local.dotmac.com;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # CORS headers for map assets
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept" always;

    # Root directory
    root /usr/share/nginx/html;
    index index.html;

    # ========================================================================
    # MAP TILES ENDPOINTS
    # ========================================================================

    # Serve map tiles with aggressive caching
    location /maps/ {
        alias /usr/share/nginx/html/maps/;

        # Apply rate limiting
        limit_req zone=gis_assets burst=20 nodelay;

        # Cache control
        expires 1d;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";

        # Try compressed versions first
        location ~* \.(js|css|svg|json)$ {
            gzip_static on;
            brotli_static on;
        }

        # Tile-specific caching
        location ~* \.(png|jpg|jpeg|webp)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }

        # Handle missing tiles gracefully
        try_files $uri $uri/ /maps/404.png;
    }

    # ========================================================================
    # MARKER ICONS AND ASSETS
    # ========================================================================

    location /icons/ {
        alias /usr/share/nginx/html/assets/icons/;

        limit_req zone=gis_assets burst=50 nodelay;

        expires 30d;
        add_header Cache-Control "public, immutable";

        # Icon fallback
        try_files $uri $uri/ /icons/default-marker.svg;
    }

    # ========================================================================
    # STATIC GIS ASSETS
    # ========================================================================

    location /assets/ {
        alias /usr/share/nginx/html/assets/;

        limit_req zone=gis_assets burst=30 nodelay;

        expires 7d;
        add_header Cache-Control "public";

        # Enable compression for text files
        gzip_static on;
        brotli_static on;

        # Asset versioning support
        location ~* \.(js|css)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # ========================================================================
    # API PROXY FOR GIS ENDPOINTS
    # ========================================================================

    # Proxy GIS API requests to backend
    location /api/gis/ {
        # Apply rate limiting for API calls
        limit_req zone=gis_api burst=5 nodelay;

        # Proxy settings
        proxy_pass http://gis_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;

        # Cache API responses briefly
        add_header Cache-Control "no-cache, private";
        expires -1;
    }

    # ========================================================================
    # WEBSOCKET SUPPORT FOR REAL-TIME GIS UPDATES
    # ========================================================================

    location /ws/gis/ {
        proxy_pass http://gis_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket specific settings
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ========================================================================
    # HEALTH CHECK AND MONITORING
    # ========================================================================

    location /health {
        access_log off;
        return 200 "GIS CDN healthy\n";
        add_header Content-Type text/plain;
    }

    location /metrics {
        access_log off;
        stub_status on;
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
    }

    # ========================================================================
    # SECURITY AND OPTIMIZATION
    # ========================================================================

    # Deny access to sensitive files
    location ~ /\.(ht|git|env) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to backup files
    location ~* \.(bak|backup|old|orig|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Handle favicon requests
    location = /favicon.ico {
        log_not_found off;
        access_log off;
        expires 30d;
    }

    # Handle robots.txt
    location = /robots.txt {
        log_not_found off;
        access_log off;
    }

    # ========================================================================
    # LOGGING CONFIGURATION
    # ========================================================================

    # Custom log format for GIS requests
    log_format gis_format '$remote_addr - $remote_user [$time_local] '
                         '"$request" $status $bytes_sent '
                         '"$http_referer" "$http_user_agent" '
                         '$request_time $upstream_response_time';

    access_log /var/log/nginx/gis_access.log gis_format;
    error_log /var/log/nginx/gis_error.log warn;
}
