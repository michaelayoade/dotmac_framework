{% extends "reseller/base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Welcome back, {{ reseller.company_name }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-refresh"></i> Refresh
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card bg-primary-gradient text-white">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="h5 mb-0 text-white">{{ metrics.total_customers }}</div>
                        <div class="text-uppercase text-white-50 small">Total Customers</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-white-30"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card bg-success-gradient text-white">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="h5 mb-0 text-white">${{ "%.2f"|format(metrics.total_mrr) }}</div>
                        <div class="text-uppercase text-white-50 small">Monthly Recurring Revenue</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x text-white-30"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card bg-warning-gradient text-white">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="h5 mb-0 text-white">${{ "%.2f"|format(financial.pending_commissions) }}</div>
                        <div class="text-uppercase text-white-50 small">Pending Commissions</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-white-30"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card bg-info-gradient text-white">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="h5 mb-0 text-white">{{ "%.1f"|format(metrics.growth_rate) }}%</div>
                        <div class="text-uppercase text-white-50 small">Growth Rate</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-white-30"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-area me-1"></i>
                Revenue Trends
            </div>
            <div class="card-body">
                <canvas id="revenueChart" width="100" height="40"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie me-1"></i>
                Customer Status
            </div>
            <div class="card-body">
                <canvas id="customerStatusChart" width="100" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Quick Stats -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clock me-1"></i>
                Recent Customer Activity
            </div>
            <div class="card-body">
                {% if recent_activity %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>MRR</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in recent_activity[:10] %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ activity.company_name }}</div>
                                    <small class="text-muted">{{ activity.customer_id }}</small>
                                </td>
                                <td>{{ activity.service_type or 'N/A' }}</td>
                                <td>${{ "%.2f"|format(activity.mrr) }}</td>
                                <td>
                                    <span class="badge {% if activity.status == 'active' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ activity.status }}
                                    </span>
                                </td>
                                <td>{{ activity.created_at }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center">
                    <a href="/reseller/portal/customers" class="btn btn-primary btn-sm">
                        View All Customers
                    </a>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No recent activity</h5>
                    <p class="text-muted">Customer activity will appear here once you have customers assigned.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-trophy me-1"></i>
                Performance Summary
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-12 mb-3">
                        <div class="h4 text-primary">{{ performance.customers_added or 0 }}</div>
                        <div class="text-muted small">Customers Added (6 months)</div>
                    </div>
                    <div class="col-6">
                        <div class="h5 text-success">{{ metrics.active_customers }}</div>
                        <div class="text-muted small">Active</div>
                    </div>
                    <div class="col-6">
                        <div class="h5 text-warning">{{ performance.customers_churned or 0 }}</div>
                        <div class="text-muted small">Churned</div>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <h6 class="text-muted">Commission Rate</h6>
                    <div class="h4 text-success">{{ "%.1f"|format(financial.commission_rate) }}%</div>
                </div>
                <hr>
                <div class="text-center">
                    <h6 class="text-muted">Next Payment</h6>
                    <div class="text-muted">{{ financial.next_payment_due or 'TBD' }}</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Revenue Trend Chart
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
const revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Monthly Revenue',
            data: [8500, 9200, 9800, 10200, 11100, {{ metrics.total_mrr }}],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Customer Status Chart
const statusCtx = document.getElementById('customerStatusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Active', 'Pending', 'Churned'],
        datasets: [{
            data: [{{ metrics.active_customers }}, 2, {{ performance.customers_churned or 0 }}],
            backgroundColor: ['#4CAF50', '#ff9800', '#f44336']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Auto-refresh every 5 minutes
setInterval(function() {
    fetch('/reseller/portal/api/metrics')
        .then(response => response.json())
        .then(data => {
            // Update key metrics (simplified)
            location.reload();
        })
        .catch(error => console.error('Auto-refresh failed:', error));
}, 300000); // 5 minutes
</script>
{% endblock %}