#!/bin/bash
# Generate comprehensive test reports for DotMac Framework

set -e

# Create reports directory
mkdir -p test-reports/{coverage,performance,security}

echo "ðŸ§ª Generating comprehensive test reports..."

# Run tests with coverage and reporting
echo "ðŸ“Š Running tests with coverage reporting..."
/root/.local/share/pypoetry/venv/bin/poetry run pytest \
    --cov-report=html:test-reports/coverage/html \
    --cov-report=xml:test-reports/coverage/coverage.xml \
    --cov-report=json:test-reports/coverage/coverage.json \
    --junit-xml=test-reports/junit.xml \
    --html=test-reports/test-report.html \
    --self-contained-html \
    --benchmark-json=test-reports/performance/benchmark.json

# Generate coverage badge
echo "ðŸŽ¯ Generating coverage badge..."
/root/.local/share/pypoetry/venv/bin/poetry run coverage-badge -o test-reports/coverage/badge.svg

# Generate performance summary
echo "âš¡ Generating performance summary..."
cat > test-reports/performance/summary.md << EOF
# Performance Test Summary

Generated on: $(date -Iseconds)

## Test Execution Summary
- Total test duration: $(grep -o '"duration": [0-9.]*' test-reports/performance/benchmark.json | head -1 | cut -d' ' -f2)s
- Tests with performance benchmarks: $(grep -c '"benchmark"' test-reports/performance/benchmark.json || echo "0")

## Coverage Summary
$(grep -A 5 -B 5 "TOTAL" test-reports/coverage/coverage.xml | head -10 || echo "Coverage data not available")

## Test Categories Executed
$(grep -o 'markers="[^"]*"' test-reports/junit.xml | sort | uniq -c | sort -nr || echo "No markers found")

EOF

# Generate security test summary if available
if [ -f test-reports/security-scan.json ]; then
    echo "ðŸ”’ Generating security summary..."
    cat > test-reports/security/summary.md << EOF
# Security Test Summary

Generated on: $(date -Iseconds)

$(cat test-reports/security-scan.json | jq -r '.summary // "No security scan results available"')
EOF
fi

# Create overall summary
echo "ðŸ“‹ Creating overall test summary..."
cat > test-reports/README.md << EOF
# DotMac Framework Test Reports

Generated on: $(date -Iseconds)

## ðŸ“Š Coverage Report
- **HTML Report**: [coverage/html/index.html](coverage/html/index.html)
- **XML Report**: [coverage/coverage.xml](coverage/coverage.xml)
- **Coverage Badge**: ![Coverage](coverage/badge.svg)

## ðŸ§ª Test Results
- **Detailed Test Report**: [test-report.html](test-report.html)
- **JUnit XML**: [junit.xml](junit.xml)

## âš¡ Performance Reports
- **Benchmark Results**: [performance/benchmark.json](performance/benchmark.json)
- **Performance Summary**: [performance/summary.md](performance/summary.md)

## ðŸ”’ Security Reports
- **Security Summary**: [security/summary.md](security/summary.md)

## Test Categories

### âœ… Unit Tests
Fast, isolated tests of individual components

### ðŸ”— Integration Tests  
Tests of component interactions and service integrations

### ðŸš€ End-to-End Tests
Complete user workflow testing across all services

### ðŸ“Š Performance Tests
Load, stress, and database performance validation

### ðŸŽ¯ Event-Driven Architecture Tests
Message ordering, saga patterns, and event sourcing validation

### ðŸ‘¤ User Journey Tests
Complete customer lifecycle testing

---
*Generated by DotMac Framework Test Suite*
EOF

echo "âœ… Test reports generated successfully!"
echo "ðŸ“ Reports available in: test-reports/"
echo "ðŸŒ Open test-reports/README.md for navigation"